<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="utf-8">
  <title>رفع صورة مع عنوان</title>
</head>
<body>
  <h1>رفع صورة مع عنوان (bucket باسم adger)</h1>
  <input type="text" id="titleInput" placeholder="أدخل عنوان الصورة">
  <br><br>
  <input type="file" id="fileInput" accept="image/*">
  <button id="uploadBtn">رفع الصورة</button>

  <div id="gallery" style="margin-top:20px;"></div>
  
  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

    const supabase = createClient(
      'https://aagsmtkuygnlgeyboarg.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFhZ3NtdGt1eWdubGdleWJvYXJnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ3NDQzNDEsImV4cCI6MjA3MDMyMDM0MX0.rgMrAM3vURYo7bFvy9okiogXEh9wyFwp9Z0yAxBE9SI'
    )

    const titleInput = document.getElementById('titleInput')
    const fileInput = document.getElementById('fileInput')
    const uploadBtn = document.getElementById('uploadBtn')
    const gallery = document.getElementById('gallery')

    uploadBtn.addEventListener('click', async () => {
      const file = fileInput.files[0]
      const title = titleInput.value.trim()

      if (!title) {
        alert('أدخل عنوان الصورة')
        return
      }
      if (!file) {
        alert('اختر صورة أولاً')
        return
      }

      const filePath = `uploads/${Date.now()}_${file.name}`
      const { data, error } = await supabase.storage
        .from('adger')
        .upload(filePath, file, {
          cacheControl: '3600',
          upsert: false,
          contentType: file.type
        })

      if (error) {
        console.error('خطأ في الرفع:', error)
        alert('فشل رفع الصورة')
      } else {
        const { data: publicData } = supabase
          .storage
          .from('adger')
          .getPublicUrl(data.path)

        // حفظ العنوان والرابط في جدول images
        const { error: insertError } = await supabase
          .from('images')
          .insert([{ title: title, url: publicData.publicUrl }])

        if (insertError) {
          console.error('خطأ في حفظ البيانات:', insertError)
        }

        // عرض الصورة والعنوان في الصفحة
        const div = document.createElement('div')
        div.style.marginBottom = '15px'
        const img = document.createElement('img')
        img.src = publicData.publicUrl
        img.style.maxWidth = '300px'
        const caption = document.createElement('p')
        caption.textContent = title
        div.appendChild(img)
        div.appendChild(caption)
        gallery.appendChild(div)

        alert('تم رفع الصورة مع العنوان!')
      }
    })
  </script>
</body>
</html>
