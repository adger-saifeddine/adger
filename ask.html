<!DOCTYPE html>

<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase Chat - ÿ≠ŸÇŸÑ 2</title>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-database.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap');

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Cairo', sans-serif;
            height: 100vh;
            background: #f5f5f5;
            position: relative;
            overflow-y: auto;
            padding-bottom: 80px; /* To ensure the input container doesn't overlap messages */
        }

        #messages {
            padding: 15px;
        }

        .message-container {
            margin-bottom: 15px;
            padding: 10px;
            max-width: 90%; /* Prevent container from being too wide */
        }

        .message-wrapper {
            display: flex;
            align-items: flex-end; /* Aligns icon with the bottom of the message bubble */
            gap: 8px; /* Space between message and icon */
        }

        .reply-icon-button {
            background: none;
            border: none;
            cursor: pointer;
            padding: 5px;
            margin-bottom: 5px; /* Align with the message bubble bottom padding */
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
        }

        .reply-icon-button:hover {
            background-color: #e0e0e0;
        }

        .reply-icon-button svg {
            width: 20px;
            height: 20px;
            stroke: #555;
        }

        .message-content {
            position: relative;
            padding: 12px 15px;
            border-radius: 20px;
            background-color: #f1f1f1;
            margin-top: 0;
            word-break: break-word;
            display: inline-block;
            width: fit-content;
        }

        .message-text {
            padding-right: 70px;
            line-height: 1.4;
            word-wrap: break-word;
            white-space: pre-wrap;
            max-width: 300px;
        }

        .message-meta {
            position: absolute;
            bottom: 6px;
            right: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .message-author {
            font-weight: 600;
            font-size: 0.85em;
            color: #444;
            display: block;
            margin-bottom: 4px;
        }

        .message-timestamp {
            font-size: 0.65em;
            color: #252525;
            opacity: 0.8;
            direction: ltr;
            white-space: nowrap;
        }

        .reply-text {
            display: flex;
            align-items: flex-start;
            margin-top: 10px;
            margin-right: 30px; /* Indent replies */
        }

        .reply-indicator {
            margin-left: 8px;
            margin-top: 12px;
            color: #888;
        }

        .reply-indicator svg {
            width: 18px;
            height: 18px;
            stroke: currentColor;
            stroke-width: 1.5;
        }

        .reply-main-content {
            flex: 1;
        }

        .reply-text .message-content {
            background-color: #e9e9e9;
        }

        .hidden-message {
            width: 100%;
            background-color: #f5f5f5;
            color: #000000;
            padding: 10px 12px;
            font-size: 15px;
            position: fixed;
            top: -1px;
            left: 0;
            z-index: 1;
            display: flex;
            flex-direction: row-reverse;
            align-items: center;
            gap: 2px;
            box-shadow: 0 3px 1px -2px rgba(37, 37, 37, 0.1);
        }

        .back-arrow {
            width: 24px;
            height: 24px;
            cursor: pointer;
        }

        .back-arrow svg {
            width: 16px;
            height: 16px;
            margin-top: 5px;
            fill: none;
            stroke: rgb(0, 0, 0);
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
        }

        #hiddenMessageText {
            margin-right: 10px;
        }

        #field2 {
            position: fixed;
            bottom: 0;
            width: 100%;
            background: white;
            display: flex;
            padding: 15px;
            border-top: 1px solid #ddd;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
        }

        #field2 textarea {
            flex: 1;
            padding: 0 15px;
            border: 1px solid #ccc;
            border-radius: 25px;
            margin-right: 10px;
            font-size: 14px;
            outline: none;
            direction: rtl;
            text-align: right;
            resize: none;
            height: 40px;
            line-height: 40px;
            overflow: hidden;
            white-space: nowrap;
        }

        #field2 textarea::placeholder {
            direction: rtl;
            text-align: right;
            line-height: 40px;
        }

        #field2 button {
            padding: 0 30px;
            height: 40px;
            margin-right: -5px;
            border: none;
            background-color: #000;
            color: white;
            border-radius: 25px;
            cursor: pointer;
            transition: opacity 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #field2 button:active {
            opacity: 0.8;
        }

        #emptyState, #loadingSpinner {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            display: none;
        }

        #emptyState span { font-size: 48px; opacity: 0.6; }
        #emptyState p { font-size: 16px; color: #666; margin-top: 8px; }

        .spinner {
            width: 35px;
            height: 35px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .message-container .message-content[data-author="admin"] {
            background-color: rgba(0, 89, 255, 0.1);
        }
    </style>
</head>
<body>
    <div style="padding-bottom: 12px; color: #ffffff;">ÿßŸÑŸÜÿµ ÿßŸÑÿ£ŸàŸÑ</div>

    <div id="messages"></div>
    <div id="emptyState">
        <span>üì≠</span>
        <p>ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ±ÿ≥ÿßÿ¶ŸÑ ŸÑŸáÿ∞ÿß ÿßŸÑŸÖŸàÿ∂Ÿàÿπ</p>
    </div><br><br>
    <div id="loadingSpinner">
        <div class="spinner"></div>
    </div>

    <div id="field2">
        <textarea id="commentText" placeholder="ÿßŸÉÿ™ÿ® ÿ±ÿ≥ÿßŸÑÿ™ŸÉ ŸáŸÜÿß..." required></textarea>
        <button id="submitButton">ÿ•ÿ±ÿ≥ÿßŸÑ</button>
    </div>

    <div id="hiddenMessage" class="hidden-message">
        <div class="back-arrow">
            <svg viewBox="0 0 24 24"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m9 5 7 7-7 7"/></svg>
        </div>
        <span id="hiddenMessageText">ÿßŸÑŸÜÿµ ÿßŸÑŸÖÿÆŸÅŸä</span>
    </div>
</body>
</html>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const firebaseConfig = {
            apiKey: "AIzaSyA8a5iw8Sbu_RiPMJBpa0tm83KZpI7Tg-o",
            authDomain: "project-536517259111.firebaseapp.com",
            databaseURL: "https://adger-12f9b-default-rtdb.firebaseio.com",
            projectId: "adger-12f9b",
            storageBucket: "adger-12f9b.appspot.com",
            messagingSenderId: "536517259111",
            appId: "1:536517259111:web:abcdef123456"
        };

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const messagesRef = database.ref('messages');

        const urlParams = new URLSearchParams(window.location.search);
        const productIdentifier = urlParams.get('message');
        
        const loadingSpinner = document.getElementById('loadingSpinner');
        loadingSpinner.style.display = 'block';

        if (!productIdentifier) {
            loadingSpinner.style.display = 'none';
            document.getElementById('messages').innerHTML = '<p style="text-align: center; color: red; padding: 20px;">ÿÆÿ∑ÿ£: ŸÑŸÖ Ÿäÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿØ ŸÖŸàÿ∂Ÿàÿπ ÿßŸÑÿ±ÿ≥ÿßÿ¶ŸÑ ŸÅŸä ÿßŸÑÿ±ÿßÿ®ÿ∑.</p>';
            document.getElementById('field2').style.display = 'none';
            document.getElementById('hiddenMessage').style.display = 'none';
            return;
        }
        
        document.getElementById('hiddenMessageText').textContent = productIdentifier;

        const productMessagesQuery = messagesRef.orderByChild('productId').equalTo(productIdentifier);

        productMessagesQuery.once('value').then(snapshot => {
            loadingSpinner.style.display = 'none';
            document.getElementById('messages').innerHTML = '';

            if (snapshot.exists()) {
                snapshot.forEach(child => {
                    createMessageElement(child.key, child.val());
                });
                document.getElementById('emptyState').style.display = 'none';
            } else {
                document.getElementById('emptyState').style.display = 'block';
            }
        }).catch(error => {
            console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ:', error);
            loadingSpinner.style.display = 'none';
        });

        document.getElementById('submitButton').addEventListener('click', e => {
            e.preventDefault();
            const textInput = document.getElementById('commentText');
            const message = textInput.value.trim();
            const username = localStorage.getItem('username');
            const hiddenMessage = document.getElementById('hiddenMessageText').textContent;

            if (!username) {
                alert('ÿßŸÑÿ±ÿ¨ÿßÿ° ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ÿ£ŸàŸÑÿßŸã');
                window.location.href = 'account.html';
                return;
            }

            if (message) {
                messagesRef.push({
                    text: message,
                    author: username,
                    productId: hiddenMessage,
                    replies: [],
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    hiddenMessage: hiddenMessage || ''
                }).then(() => {
                    textInput.value = '';
                    textInput.focus();
                }).catch(error => console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ•ÿ±ÿ≥ÿßŸÑ:', error));
            }
        });

        productMessagesQuery.on('child_added', snapshot => {
            if (!document.querySelector(`[data-message-id="${snapshot.key}"]`)) {
                createMessageElement(snapshot.key, snapshot.val());
            }
            document.getElementById('emptyState').style.display = 'none';
        });

        productMessagesQuery.on('child_removed', snapshot => {
            const messageElement = document.querySelector(`[data-message-id="${snapshot.key}"]`);
            if (messageElement) messageElement.remove();
            checkEmptyState();
        });

        function createMessageElement(id, {text, author, replies, timestamp, hiddenMessage}) {
            const container = document.createElement('div');
            container.className = 'message-container';
            container.dataset.messageId = id;

            const formattedTime = formatTimestamp(timestamp);
            
            container.innerHTML = `
                <span class="message-author">${author}</span>
                <div class="message-wrapper">
                    <div class="message-content" data-author="${author}">
                        <div class="message-text">${text}</div>
                        <div class="message-meta">
                            <span class="message-timestamp">${formattedTime}</span>
                        </div>
                    </div>
                    <button class="reply-icon-button" title="ÿ±ÿØ ÿπŸÑŸâ Ÿáÿ∞Ÿá ÿßŸÑÿ±ÿ≥ÿßŸÑÿ©">
                        <svg fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                           <path stroke-linecap="round" stroke-linejoin="round" d="M9 15L3 9m0 0l6-6M3 9h12a6 6 0 010 12h-3" />
                        </svg>
                    </button>
                </div>
            `;

            const replyButton = container.querySelector('.reply-icon-button');
            replyButton.addEventListener('click', () => {
                const username = localStorage.getItem('username');
                if (!username) {
                    alert('ÿßŸÑÿ±ÿ¨ÿßÿ° ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ÿ£ŸàŸÑÿßŸã ŸÑŸÑÿ±ÿØ');
                    return;
                }
                
                // --- MODIFICATION: Show original message in prompt ---
                const replyText = prompt(`ÿßŸÑÿ±ÿØ ÿπŸÑŸâ:\n"${text}"`);
                
                if (replyText && replyText.trim() !== '') {
                    const messageId = container.dataset.messageId;
                    const repliesRef = database.ref(`messages/${messageId}/replies`);
                    repliesRef.push({
                        author: username,
                        text: replyText.trim(),
                        timestamp: firebase.database.ServerValue.TIMESTAMP
                    }).catch(error => console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑÿ±ÿØ:', error));
                }
            });

            if (replies) {
                Object.values(replies).forEach((reply, index) => {
                    addReply(container, Object.keys(replies)[index], reply);
                });
            }

            document.getElementById('messages').appendChild(container);
            // --- MODIFICATION: Removed automatic scroll ---
            // container.scrollIntoView({ behavior: 'smooth' });

            database.ref(`messages/${id}/replies`).on('child_added', snapshot => {
                addReply(container, snapshot.key, snapshot.val());
            });
        }

        function addReply(container, replyId, {author, text, timestamp}) {
            if (!container.querySelector(`[data-reply-id="${replyId}"]`)) {
                const replyDiv = document.createElement('div');
                replyDiv.className = 'reply-text';
                replyDiv.dataset.replyId = replyId;

                const formattedTime = formatTimestamp(timestamp);
                
                replyDiv.innerHTML = `
                    <div class="reply-main-content">
                        <span class="message-author">${author}</span>
                        <div class="message-content">
                            <div class="message-text">${text}</div>
                            <div class="message-meta">
                                <span class="message-timestamp">${formattedTime}</span>
                            </div>
                        </div>
                    </div>
                `;

                container.appendChild(replyDiv);
                // --- MODIFICATION: Removed automatic scroll ---
                // replyDiv.scrollIntoView({ behavior: 'smooth' });
            }
        }

        function formatTimestamp(timestamp) {
            if (!timestamp) return '';
            const messageDate = new Date(timestamp);
            const currentDate = new Date();
            if (
                messageDate.getDate() === currentDate.getDate() &&
                messageDate.getMonth() === currentDate.getMonth() &&
                messageDate.getFullYear() === currentDate.getFullYear()
            ) {
                const hours = messageDate.getHours();
                const minutes = messageDate.getMinutes().toString().padStart(2, '0');
                const period = hours >= 12 ? 'ŸÖÿ≥ÿßÿ°Ÿã' : 'ÿµÿ®ÿßÿ≠Ÿãÿß';
                const formattedHours = hours % 12 || 12;
                return `${formattedHours}:${minutes} ${period}`;
            } else {
                const options = { day: '2-digit', month: '2-digit', year: 'numeric' };
                return messageDate.toLocaleDateString('ar-EG', options);
            }
        }

        function checkEmptyState() {
            productMessagesQuery.once('value').then(snapshot => {
                document.getElementById('emptyState').style.display = snapshot.exists() ? 'none' : 'block';
            });
        }

        document.querySelector('.back-arrow').addEventListener('click', () => {
            window.history.back();
        });
    });
</script>

</body>
</html>