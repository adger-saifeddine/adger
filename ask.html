<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase Chat - ÿ≠ŸÇŸÑ 2</title>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-database.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap');
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Cairo', sans-serif;
            height: 100vh;
            background: #f5f5f5;
            position: relative;
            overflow-y: auto;
        }
        
        #messages {
            padding: 15px;
            padding-bottom: 150px; /* Extra space for visibility above input area */
        }
        
        .message-container {
            margin-bottom: 15px;
        }
        
        .message-content {
            position: relative;
            padding: 12px 15px;
            border-radius: 20px;
            background-color: #f1f1f1;
            max-width: 85%;
            word-break: break-word;
            display: inline-block;
            width: fit-content;
        }

        .message-text {
            padding-left: 25px; /* Space for reply icon */
            padding-right: 70px; /* Space for timestamp */
            line-height: 1.4;
            word-wrap: break-word;
            white-space: pre-wrap;
        }

        .message-meta {
            position: absolute;
            bottom: 6px;
            right: 12px;
            display: flex;
            align-items: center;
            gap: 8px; /* Increased gap */
        }

        /* New Reply Icon Style */
        .reply-icon {
            cursor: pointer;
            width: 18px;
            height: 18px;
            opacity: 0.6;
            transition: opacity 0.2s;
            position: absolute; /* Position it inside the message bubble */
            bottom: 7px;
            left: 15px;
        }
        .reply-icon:hover {
            opacity: 1;
        }
        .reply-icon svg {
             width: 100%;
             height: 100%;
             fill: #555;
        }

        .message-author {
            font-weight: 600;
            font-size: 0.85em;
            color: #444;
            display: block;
            margin-bottom: 4px;
            padding: 0 10px;
        }

        .message-timestamp {
            font-size: 0.65em;
            color: #252525;
            opacity: 0.8;
            direction: ltr;
            white-space: nowrap;
        }
        
        .replies-section {
            padding-right: 25px; /* Indent replies */
            margin-top: 10px;
            border-right: 2px solid #e0e0e0;
        }

        .reply-text {
            margin-top: 8px;
        }

        .reply-text .message-content {
            background-color: #e9e9e9; /* Slightly different color for replies */
        }
        
        .hidden-message {
            width: 100%;
            background-color: #f5f5f5;
            color: #000000;
            padding: 10px 12px;
            font-size: 15px;
            position: fixed;
            top: 0;
            left: 0;
            z-index: 10;
            display: none; /* Hidden by default, shown by JS */
            flex-direction: row-reverse;
            align-items: center;
            gap: 2px;
            box-shadow: 0 3px 1px -2px rgba(37, 37, 37, 0.1);
        }

        .back-arrow {
            width: 24px;
            height: 24px;
            cursor: pointer;
        }

        .back-arrow svg {
            width: 16px;
            height: 16px;
            margin-top: 5px;
            fill: none;
            stroke: rgb(0, 0, 0);
            stroke-width: 2;
        }

        #hiddenMessageText {
            margin-right: 10px;
        }

        #inputContainer {
            position: fixed;
            bottom: 0;
            width: 100%;
            background: white;
            border-top: 1px solid #ddd;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            z-index: 10;
        }

        #replyContext {
            padding: 8px 15px;
            background-color: #f0f0f0;
            border-bottom: 1px solid #e0e0e0;
            font-size: 0.8em;
            color: #555;
            display: none; /* Hidden by default */
            justify-content: space-between;
            align-items: center;
        }
        #replyContextText {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 80%;
        }
        #cancelReply {
            cursor: pointer;
            font-weight: bold;
            font-size: 1.2em;
            padding: 0 5px;
        }

        #field2 {
            display: flex;
            padding: 15px;
        }
        
        #field2 textarea {
            flex: 1;
            padding: 10px 15px;
            border: 1px solid #ccc;
            border-radius: 25px;
            margin-right: 10px;
            font-size: 14px;
            outline: none;
            direction: rtl;
            text-align: right;
            resize: none;
            min-height: 40px;
            line-height: 1.4;
        }

        #field2 button {
            padding: 0 30px;
            height: 40px;
            align-self: center;
            border: none;
            background-color: #000;
            color: white;
            border-radius: 25px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        #field2 button:disabled {
            background-color: #aaa;
            cursor: not-allowed;
        }
        
        #emptyState, #loadingSpinner {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }
        
        #emptyState span { font-size: 48px; opacity: 0.6; }
        #emptyState p { font-size: 16px; color: #666; margin-top: 8px; }
        
        .spinner {
            width: 35px;
            height: 35px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .message-container .message-content[data-author="admin"] {
            background-color: rgba(0, 89, 255, 0.1);
        }
    </style>
</head>
<body>
    <div id="hiddenMessage" class="hidden-message">
        <div class="back-arrow">
            <svg viewBox="0 0 24 24"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m9 5 7 7-7 7"/></svg>
        </div>
        <span id="hiddenMessageText"></span>
    </div>

    <div id="messages"></div>
    <div id="emptyState" style="display: none;">
        <span>üì≠</span>
        <p>ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ±ÿ≥ÿßÿ¶ŸÑ</p>
    </div>
    <div id="loadingSpinner"><div class="spinner"></div></div>

    <div id="inputContainer">
        <div id="replyContext">
            <span id="replyContextText"></span>
            <span id="cancelReply">&times;</span>
        </div>
        <div id="field2">
            <textarea id="commentText" placeholder="ÿßŸÉÿ™ÿ® ÿ±ÿ≥ÿßŸÑÿ™ŸÉ ŸáŸÜÿß..." required></textarea>
            <button id="submitButton">ÿ•ÿ±ÿ≥ÿßŸÑ</button>
        </div>
    </div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const firebaseConfig = {
            apiKey: "AIzaSyA8a5iw8Sbu_RiPMJBpa0tm83KZpI7Tg-o",
            authDomain: "project-536517259111.firebaseapp.com",
            databaseURL: "https://adger-12f9b-default-rtdb.firebaseio.com",
            projectId: "adger-12f9b",
            storageBucket: "adger-12f9b.appspot.com",
            messagingSenderId: "536517259111",
            appId: "1:536517259111:web:abcdef123456"
        };

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // --- 1. Get Chat ID from URL (New Feature) ---
        const urlParams = new URLSearchParams(window.location.search);
        const chatId = urlParams.get('id');
        
        if (!chatId) {
            document.body.innerHTML = '<h1 style="text-align: center; margin-top: 50px; font-family: Cairo, sans-serif;">ÿÆÿ∑ÿ£: ŸÑŸÖ Ÿäÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿØ ŸÖÿπÿ±ŸÅ ŸÑŸÑÿØÿ±ÿØÿ¥ÿ©. Ÿäÿ±ÿ¨Ÿâ ÿßŸÑÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ£ŸÜ ÿßŸÑÿ±ÿßÿ®ÿ∑ Ÿäÿ≠ÿ™ŸàŸä ÿπŸÑŸâ ?id=...</h1>';
            return;
        }

        // --- 2. Create a unique reference for this chat ID (New Feature) ---
        const messagesRef = database.ref('chats/' + chatId);

        // --- DOM Elements ---
        const loadingSpinner = document.getElementById('loadingSpinner');
        const messagesDiv = document.getElementById('messages');
        const emptyStateDiv = document.getElementById('emptyState');
        const submitButton = document.getElementById('submitButton');
        const commentText = document.getElementById('commentText');
        const replyContext = document.getElementById('replyContext');
        const replyContextText = document.getElementById('replyContextText');
        const cancelReplyButton = document.getElementById('cancelReply');

        let replyingToMessageId = null; // State for tracking replies

        // --- Initial Load ---
        messagesRef.once('value').then(snapshot => {
            loadingSpinner.style.display = 'none';
            checkEmptyState(snapshot);
            if (snapshot.exists()) {
                snapshot.forEach(child => {
                    createMessageElement(child.key, child.val());
                });
            }
        }).catch(error => {
            console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ:', error);
            loadingSpinner.style.display = 'none';
        });

        // --- Event Listeners ---
        submitButton.addEventListener('click', sendMessage);
        cancelReplyButton.addEventListener('click', cancelReply);

        // --- Real-time Listeners ---
        messagesRef.on('child_added', snapshot => {
            if (!document.querySelector(`[data-message-id="${snapshot.key}"]`)) {
                createMessageElement(snapshot.key, snapshot.val());
            }
            checkEmptyState();
        });

        messagesRef.on('child_removed', snapshot => {
            const messageElement = document.querySelector(`[data-message-id="${snapshot.key}"]`);
            if (messageElement) messageElement.remove();
            checkEmptyState();
        });

        // --- Core Functions ---
        async function sendMessage() {
            // This check from your working code is essential
            const username = localStorage.getItem('username');
            if (!username) {
                alert('ÿßŸÑÿ±ÿ¨ÿßÿ° ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ÿ£ŸàŸÑÿßŸã');
                // Optional: redirect to login/account page
                // window.location.href = 'account.html';
                return;
            }

            const message = commentText.value.trim();
            if (!message) return;

            submitButton.disabled = true;

            const data = {
                text: message,
                author: username,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            };

            try {
                // --- 3. Logic to handle both new messages and replies (New Feature) ---
                if (replyingToMessageId) {
                    // Send as a reply
                    const replyRef = messagesRef.child(replyingToMessageId).child('replies');
                    await replyRef.push(data);
                    cancelReply();
                } else {
                    // Send as a new message
                    const hiddenMessage = document.getElementById('hiddenMessageText').textContent;
                    if (hiddenMessage.trim()) data.hiddenMessage = hiddenMessage;
                    await messagesRef.push(data);
                }
                commentText.value = '';
            } catch (error) {
                console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ•ÿ±ÿ≥ÿßŸÑ:', error);
                alert('ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑÿ±ÿ≥ÿßŸÑÿ©.');
            } finally {
                submitButton.disabled = false;
                commentText.focus();
            }
        }

        function createMessageElement(id, {text, author, replies, timestamp, hiddenMessage}) {
            const container = document.createElement('div');
            container.className = 'message-container';
            container.dataset.messageId = id;

            const formattedTime = formatTimestamp(timestamp);
            let hiddenMsgHTML = hiddenMessage ? `<div style="font-size: 12px; margin-bottom: 5px; opacity: 0.7; border-bottom: 1px solid #ddd; padding-bottom: 5px;">${hiddenMessage}</div>` : '';

            container.innerHTML = `
                <span class="message-author">${author}</span>
                <div class="message-content" data-author="${author}">
                    ${hiddenMsgHTML}
                    <div class="message-text">${text}</div>
                    <div class="message-meta">
                        <span class="message-timestamp">${formattedTime}</span>
                    </div>
                    <!-- 4. Added Reply Icon to UI (New Feature) -->
                    <div class="reply-icon" title="ÿ±ÿØ">
                       <svg viewBox="0 0 24 24"><path d="M10,9V5L3,12L10,19V14.9C15,14.9,18.5,16.5,21,20C20,15,17,10,10,9Z" /></svg>
                    </div>
                </div>
                <div class="replies-section"></div>
            `;
            
            messagesDiv.appendChild(container);

            // Add event listener to the new reply icon
            container.querySelector('.reply-icon').addEventListener('click', () => {
                replyingToMessageId = id;
                replyContextText.textContent = `ÿßŸÑÿ±ÿØ ÿπŸÑŸâ: "${text.substring(0, 30)}..."`;
                replyContext.style.display = 'flex';
                commentText.focus();
            });

            const repliesSection = container.querySelector('.replies-section');
            if (replies) {
                Object.entries(replies).forEach(([replyId, reply]) => {
                    addReply(repliesSection, replyId, reply);
                });
            }
            // Listen for new replies on this specific message
            messagesRef.child(id).child('replies').on('child_added', snapshot => {
                addReply(repliesSection, snapshot.key, snapshot.val());
            });

            container.scrollIntoView({ behavior: 'smooth', block: 'end' });
        }

        function addReply(repliesSection, replyId, {author, text, timestamp}) {
            // Prevent adding duplicate replies on screen
            if (repliesSection.querySelector(`[data-reply-id="${replyId}"]`)) return;
            
            const replyDiv = document.createElement('div');
            replyDiv.className = 'reply-text';
            replyDiv.dataset.replyId = replyId;

            replyDiv.innerHTML = `
                <span class="message-author">${author}</span>
                <div class="message-content">
                    <div class="message-text">${text}</div>
                    <div class="message-meta">
                        <span class="message-timestamp">${formatTimestamp(timestamp)}</span>
                    </div>
                </div>
            `;
            repliesSection.appendChild(replyDiv);
        }

        function cancelReply() {
            replyingToMessageId = null;
            replyContext.style.display = 'none';
        }

        function formatTimestamp(timestamp) {
            if (!timestamp) return '';
            const messageDate = new Date(timestamp);
            return messageDate.toLocaleTimeString('ar-EG', { hour: 'numeric', minute: '2-digit', hour12: true });
        }
        
        function checkEmptyState(snapshot) {
            const check = snap => emptyStateDiv.style.display = snap.exists() ? 'none' : 'block';
            if (snapshot) check(snapshot);
            else messagesRef.once('value').then(check);
        }

        // Handle the top info bar based on URL parameters
        const messageParam = urlParams.get('message');
        const hiddenMessageDiv = document.getElementById('hiddenMessage');
        if (messageParam) {
            document.getElementById('hiddenMessageText').textContent = messageParam;
            hiddenMessageDiv.style.display = 'flex';
            document.body.style.paddingTop = `${hiddenMessageDiv.offsetHeight}px`;
        }
        document.querySelector('.back-arrow').addEventListener('click', () => window.history.back());
    });
</script>
</body>
</html>